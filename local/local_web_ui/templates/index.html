<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tibber Graph - Configuration Test</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <img src="https://brands.home-assistant.io/tibber_graph/dark_icon.png" alt="Tibber Graph" class="logo">
            <h1>Tibber Graph Options</h1>
        </header>

        <div class="content">
            <div class="sidebar">
                <form id="config-form">
                    <div class="section">
                        <h2>General Settings</h2>

                        <div class="form-group">
                            <label for="theme">Theme</label>
                            <select id="theme" name="theme">
                                <option value="dark" {% if defaults.theme == 'dark' %}selected{% endif %}>Dark</option>
                                <option value="light" {% if defaults.theme == 'light' %}selected{% endif %}>Light</option>
                            </select>
                        </div>

                        <div class="form-group checkbox">
                            <label>
                                <input type="checkbox" id="transparent_background" name="transparent_background" {% if defaults.transparent_background %}checked{% endif %}>
                                <span>Transparent Background</span>
                            </label>
                        </div>

                        <div class="form-group">
                            <label for="canvas_width">Canvas Width</label>
                            <input type="number" id="canvas_width" name="canvas_width" value="{{ defaults.canvas_width }}" min="100" max="2000">
                        </div>

                        <div class="form-group">
                            <label for="canvas_height">Canvas Height</label>
                            <input type="number" id="canvas_height" name="canvas_height" value="{{ defaults.canvas_height }}" min="100" max="2000">
                        </div>

                        <div class="form-group checkbox">
                            <label>
                                <input type="checkbox" id="force_fixed_size" name="force_fixed_size" {% if defaults.force_fixed_size %}checked{% endif %}>
                                <span>Force Fixed Size</span>
                            </label>
                        </div>

                        <div class="form-group">
                            <label for="label_font_size">Label Font Size</label>
                            <input type="number" id="label_font_size" name="label_font_size" value="{{ defaults.label_font_size }}" min="8" max="32">
                        </div>

                        <div class="form-group">
                            <label for="start_graph_at">Start Graph At</label>
                            <select id="start_graph_at" name="start_graph_at">
                                <option value="midnight" {% if defaults.start_graph_at == 'midnight' %}selected{% endif %}>Midnight</option>
                                <option value="current_hour" {% if defaults.start_graph_at == 'current_hour' %}selected{% endif %}>Current hour</option>
                                <option value="show_all" {% if defaults.start_graph_at == 'show_all' %}selected{% endif %}>Show all</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="hours_to_show">Hours to Show (leave empty for all)</label>
                            <input type="number" id="hours_to_show" name="hours_to_show" value="{{ defaults.hours_to_show }}" min="1" max="48">
                        </div>

                        <div class="form-group">
                            <label for="cheap_price_points">Cheap Price Points (0 = none)</label>
                            <input type="number" id="cheap_price_points" name="cheap_price_points" value="{{ defaults.cheap_price_points }}" min="0" max="96">
                        </div>

                        <div class="form-group">
                            <label for="cheap_price_threshold">Cheap Price Threshold (0 = disabled, e.g., 0.5)</label>
                            <input type="number" id="cheap_price_threshold" name="cheap_price_threshold" value="{{ defaults.cheap_price_threshold }}" min="0" step="0.01">
                        </div>

                        <div class="form-group checkbox">
                            <label>
                                <input type="checkbox" id="show_average_price_line" name="show_average_price_line" {% if defaults.show_average_price_line %}checked{% endif %}>
                                <span>Show Average Price Line</span>
                            </label>
                        </div>

                        <div class="form-group checkbox">
                            <label>
                                <input type="checkbox" id="color_price_line_by_average" name="color_price_line_by_average" {% if defaults.color_price_line_by_average %}checked{% endif %}>
                                <span>Color Price Line by Average</span>
                            </label>
                        </div>
                    </div>

                    <div class="section">
                        <h2>Price Labels</h2>

                        <div class="form-group">
                            <label for="price_decimals">Price Decimals</label>
                            <input type="number" id="price_decimals" name="price_decimals" value="{{ defaults.price_decimals }}" min="0" max="4">
                        </div>

                        <div class="form-group checkbox">
                            <label>
                                <input type="checkbox" id="use_hourly_prices" name="use_hourly_prices" {% if defaults.use_hourly_prices %}checked{% endif %}>
                                <span>Use Hourly Prices</span>
                            </label>
                        </div>

                        <div class="form-group checkbox">
                            <label>
                                <input type="checkbox" id="use_cents" name="use_cents" {% if defaults.use_cents %}checked{% endif %}>
                                <span>Use Cents</span>
                            </label>
                        </div>

                        <div class="form-group">
                            <label for="currency_override">Currency Override</label>
                            <input type="text" id="currency_override" name="currency_override" value="{{ defaults.currency_override }}" placeholder="e.g., SEK, √∂re">
                        </div>

                        <div class="form-group">
                            <label for="label_current">Show Current Price</label>
                            <select id="label_current" name="label_current">
                                <option value="on" {% if defaults.label_current == 'on' %}selected{% endif %}>On</option>
                                <option value="on_current_price_only" {% if defaults.label_current == 'on_current_price_only' %}selected{% endif %}>On (current price only)</option>
                                <option value="on_in_graph" {% if defaults.label_current == 'on_in_graph' %}selected{% endif %}>On (in graph)</option>
                                <option value="on_in_graph_no_price" {% if defaults.label_current == 'on_in_graph_no_price' %}selected{% endif %}>On (in graph, no price)</option>
                                <option value="off" {% if defaults.label_current == 'off' %}selected{% endif %}>Off</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="label_min">Show Min Price</label>
                            <select id="label_min" name="label_min">
                                <option value="on" {% if defaults.label_min == 'on' %}selected{% endif %}>On</option>
                                <option value="on_no_price" {% if defaults.label_min == 'on_no_price' %}selected{% endif %}>On (no price)</option>
                                <option value="off" {% if defaults.label_min == 'off' %}selected{% endif %}>Off</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="label_max">Show Max Price</label>
                            <select id="label_max" name="label_max">
                                <option value="on" {% if defaults.label_max == 'on' %}selected{% endif %}>On</option>
                                <option value="on_no_price" {% if defaults.label_max == 'on_no_price' %}selected{% endif %}>On (no price)</option>
                                <option value="off" {% if defaults.label_max == 'off' %}selected{% endif %}>Off</option>
                            </select>
                        </div>
                    </div>

                    <div class="section">
                        <h2>X-Axis Settings</h2>

                        <div class="form-group">
                            <label for="show_x_axis">Show X-axis</label>
                            <select id="show_x_axis" name="show_x_axis">
                                <option value="on" {% if defaults.show_x_axis == 'on' %}selected{% endif %}>On</option>
                                <option value="on_with_tick_marks" {% if defaults.show_x_axis == 'on_with_tick_marks' %}selected{% endif %}>On (with tick marks)</option>
                                <option value="off" {% if defaults.show_x_axis == 'off' %}selected{% endif %}>Off</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="x_tick_step_hours">Tick Step (hours)</label>
                            <input type="number" id="x_tick_step_hours" name="x_tick_step_hours" value="{{ defaults.x_tick_step_hours }}" min="1" max="24">
                        </div>

                        <div class="form-group">
                            <label for="cheap_periods_on_x_axis">Highlight Cheap Periods on X-axis</label>
                            <select id="cheap_periods_on_x_axis" name="cheap_periods_on_x_axis">
                                <option value="on" {% if defaults.cheap_periods_on_x_axis == 'on' %}selected{% endif %}>On</option>
                                <option value="on_comfy" {% if defaults.cheap_periods_on_x_axis == 'on_comfy' %}selected{% endif %}>On (comfy)</option>
                                <option value="on_compact" {% if defaults.cheap_periods_on_x_axis == 'on_compact' %}selected{% endif %}>On (compact)</option>
                                <option value="off" {% if defaults.cheap_periods_on_x_axis == 'off' %}selected{% endif %}>Off</option>
                            </select>
                        </div>

                        <div class="form-group checkbox">
                            <label>
                                <input type="checkbox" id="show_vertical_grid" name="show_vertical_grid" {% if defaults.show_vertical_grid %}checked{% endif %}>
                                <span>Show Vertical Grid</span>
                            </label>
                        </div>
                    </div>

                    <div class="section">
                        <h2>Y-Axis Settings</h2>

                        <div class="form-group">
                            <label for="show_y_axis">Show Y-axis</label>
                            <select id="show_y_axis" name="show_y_axis">
                                <option value="on" {% if defaults.show_y_axis == 'on' %}selected{% endif %}>On</option>
                                <option value="on_with_tick_marks" {% if defaults.show_y_axis == 'on_with_tick_marks' %}selected{% endif %}>On (with tick marks)</option>
                                <option value="off" {% if defaults.show_y_axis == 'off' %}selected{% endif %}>Off</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="y_tick_count">Tick Count (leave empty for auto)</label>
                            <input type="number" id="y_tick_count" name="y_tick_count" value="{{ defaults.y_tick_count }}" min="1" max="20">
                        </div>

                        <div class="form-group">
                            <label for="y_axis_label_rotation_deg">Label Rotation (degrees)</label>
                            <input type="number" id="y_axis_label_rotation_deg" name="y_axis_label_rotation_deg" value="{{ defaults.y_axis_label_rotation_deg }}" min="0" max="360">
                        </div>

                        <div class="form-group">
                            <label for="y_axis_side">Y-axis Side</label>
                            <select id="y_axis_side" name="y_axis_side">
                                <option value="left" {% if defaults.y_axis_side == 'left' %}selected{% endif %}>Left</option>
                                <option value="right" {% if defaults.y_axis_side == 'right' %}selected{% endif %}>Right</option>
                            </select>
                        </div>

                        <div class="form-group checkbox">
                            <label>
                                <input type="checkbox" id="show_horizontal_grid" name="show_horizontal_grid" {% if defaults.show_horizontal_grid %}checked{% endif %}>
                                <span>Show Horizontal Grid</span>
                            </label>
                        </div>
                    </div>

                    <div class="section">
                        <h2>Refresh Settings</h2>

                        <div class="form-group">
                            <label for="refresh_mode">Refresh Mode</label>
                            <select id="refresh_mode" name="refresh_mode" class="auto-render">
                                <option value="system" {% if defaults.refresh_mode == 'system' %}selected{% endif %}>System</option>
                                <option value="system_interval" {% if defaults.refresh_mode == 'system_interval' %}selected{% endif %}>System + Interval</option>
                                <option value="interval" {% if defaults.refresh_mode == 'interval' %}selected{% endif %}>Interval</option>
                                <option value="sensor" {% if defaults.refresh_mode == 'sensor' %}selected{% endif %}>Sensor</option>
                                <option value="manual" {% if defaults.refresh_mode == 'manual' %}selected{% endif %}>Manual</option>
                            </select>
                        </div>
                    </div>

                    <div class="section">
                        <h2>Test Options</h2>

                        <div class="form-group">
                            <label for="fixed_time">Simulate Time (HH:MM)</label>
                            <input type="text" id="fixed_time" name="fixed_time" value="19:34" placeholder="e.g., 19:34" class="auto-render">
                        </div>
                    </div>

                </form>
            </div>

            <div class="main-content">
                <div class="preview-section">
                    <div class="preview-header">
                        <h2>Preview</h2>
                        <div class="status" id="status">Ready</div>
                    </div>

                    <div class="preview-container" id="preview-container">
                        <div class="placeholder">
                            <div class="placeholder-icon">üìä</div>
                            <p>Click "Render Graph" to see the preview</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating menu for theme toggle and reset -->
    <div class="floating-menu">
        <div class="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode">
            <div class="theme-toggle-slider" id="theme-slider">
                <svg class="theme-toggle-icon" id="theme-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- Moon icon (default for dark mode) -->
                    <path id="moon-icon" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <!-- Sun icon (for light mode) -->
                    <g id="sun-icon" style="display: none;">
                        <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="12" y1="1" x2="12" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="12" y1="21" x2="12" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="1" y1="12" x2="3" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="21" y1="12" x2="23" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </g>
                </svg>
            </div>
        </div>
        <button class="floating-btn" onclick="resetToDefaults()" title="Reset all settings to defaults">
            <svg id="reset-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 4v6h6M23 20v-6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
        <button class="floating-btn" onclick="openJsonOptionsDialog()" title="Set options from text">
            <svg id="json-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="14 2 14 8 20 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="10 9 9 9 8 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>

    <!-- JSON Options Dialog -->
    <div id="json-options-dialog" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Set Options</h2>
                <button class="modal-close" onclick="closeJsonOptionsDialog()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Paste your options below using the <code>key: value</code> format (one option per line). The options should match the option names used in the <code>set_option</code> action.</p>

                <div class="form-group">
                    <label for="json-options-input">Options (YAML format)</label>
                    <textarea id="json-options-input" rows="10" placeholder="theme: dark&#10;canvas_width: 1920&#10;show_x_axis: on_with_tick_marks&#10;cheap_price_points: 5"></textarea>
                </div>

                <div class="form-group checkbox">
                    <label>
                        <input type="checkbox" id="json-options-overwrite">
                        <span>Overwrite mode: Reset all options not provided to their defaults</span>
                    </label>
                </div>

                <div id="json-options-error" class="error-message" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeJsonOptionsDialog()">Cancel</button>
                <button class="btn-primary" onclick="applyJsonOptions()">Apply Options</button>
            </div>
        </div>
    </div>

    <script>
        // Theme management
        function initTheme() {
            // Check localStorage for saved theme preference, default to dark
            const savedTheme = localStorage.getItem('tibber-graph-theme') || 'dark';
            const slider = document.getElementById('theme-slider');
            const moonIcon = document.getElementById('moon-icon');
            const sunIcon = document.getElementById('sun-icon');
            const themeIcon = document.getElementById('theme-icon');
            const resetIcon = document.getElementById('reset-icon');

            if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
                slider.classList.add('light');
                moonIcon.style.display = 'none';
                sunIcon.style.display = 'block';
                themeIcon.style.color = '#ffffff';
                resetIcon.style.color = '#ffffff';
            } else {
                document.body.classList.remove('light-theme');
                slider.classList.remove('light');
                moonIcon.style.display = 'block';
                sunIcon.style.display = 'none';
                themeIcon.style.color = '#ffffff';
                resetIcon.style.color = '#ffffff';
            }
        }

        function toggleTheme() {
            const isLight = document.body.classList.toggle('light-theme');
            const slider = document.getElementById('theme-slider');
            const moonIcon = document.getElementById('moon-icon');
            const sunIcon = document.getElementById('sun-icon');
            const themeIcon = document.getElementById('theme-icon');
            const resetIcon = document.getElementById('reset-icon');

            if (isLight) {
                slider.classList.add('light');
                moonIcon.style.display = 'none';
                sunIcon.style.display = 'block';
                themeIcon.style.color = '#ffffff';
                resetIcon.style.color = '#ffffff';
                localStorage.setItem('tibber-graph-theme', 'light');
            } else {
                slider.classList.remove('light');
                moonIcon.style.display = 'block';
                sunIcon.style.display = 'none';
                themeIcon.style.color = '#ffffff';
                resetIcon.style.color = '#ffffff';
                localStorage.setItem('tibber-graph-theme', 'dark');
            }
        }

        // Storage for hidden options (not in UI but supported via YAML)
        const hiddenOptions = {};

        function getFormData() {
            const form = document.getElementById('config-form');
            const formData = new FormData(form);
            const data = {};

            // Get all text/number inputs
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            // Get all checkboxes (including unchecked ones)
            const checkboxes = form.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                data[checkbox.name] = checkbox.checked ? 'true' : 'false';
            });

            // Include hidden options (convert booleans to strings to match form data format)
            for (let [key, value] of Object.entries(hiddenOptions)) {
                // Convert boolean to string to match checkbox format
                if (typeof value === 'boolean') {
                    data[key] = value ? 'true' : 'false';
                } else {
                    data[key] = value;
                }
            }

            return data;
        }

        async function renderGraph() {
            const statusEl = document.getElementById('status');
            const previewContainer = document.getElementById('preview-container');

            statusEl.textContent = 'Rendering...';
            statusEl.className = 'status loading';

            try {
                const data = getFormData();

                const response = await fetch('/render', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to render graph');
                }

                const blob = await response.blob();
                const imageUrl = URL.createObjectURL(blob);

                previewContainer.innerHTML = `<img src="${imageUrl}" alt="Rendered Graph" class="preview-image">`;

                statusEl.textContent = 'Rendered successfully';
                statusEl.className = 'status success';

                setTimeout(() => {
                    statusEl.textContent = 'Ready';
                    statusEl.className = 'status';
                }, 3000);

            } catch (error) {
                previewContainer.innerHTML = `
                    <div class="error-message">
                        <div class="error-icon">‚ö†Ô∏è</div>
                        <p>${error.message}</p>
                    </div>
                `;

                statusEl.textContent = 'Error';
                statusEl.className = 'status error';

                console.error('Render error:', error);
            }
        }

        async function resetToDefaults() {
            try {
                const response = await fetch('/defaults');
                const defaults = await response.json();

                console.log('Resetting to defaults:', defaults);

                // Reset all form fields
                for (let [key, value] of Object.entries(defaults)) {
                    const element = document.getElementById(key);
                    if (!element) {
                        console.warn(`Element not found for key: ${key}`);
                        continue;
                    }

                    if (element.type === 'checkbox') {
                        element.checked = value;
                    } else {
                        // For select and input elements
                        element.value = value;
                    }
                    console.log(`Reset ${key} to ${value}`);
                }

                // Clear test options
                document.getElementById('fixed_time').value = '';

                // Render immediately after reset
                await renderGraph();

            } catch (error) {
                console.error('Reset error:', error);
            }
        }

        // JSON Options Dialog functions
        function openJsonOptionsDialog() {
            document.getElementById('json-options-dialog').style.display = 'flex';
            document.getElementById('json-options-input').value = '';
            document.getElementById('json-options-overwrite').checked = true;
            document.getElementById('json-options-error').style.display = 'none';
        }

        function closeJsonOptionsDialog() {
            document.getElementById('json-options-dialog').style.display = 'none';
        }

        async function applyJsonOptions() {
            const jsonInput = document.getElementById('json-options-input').value.trim();
            const overwrite = document.getElementById('json-options-overwrite').checked;
            const errorEl = document.getElementById('json-options-error');

            // Clear previous error
            errorEl.style.display = 'none';

            if (!jsonInput) {
                errorEl.textContent = 'Please provide options.';
                errorEl.style.display = 'block';
                return;
            }

            try {
                // Parse YAML-style format (key: value)
                const options = {};
                const lines = jsonInput.split('\n');

                for (const line of lines) {
                    const trimmedLine = line.trim();

                    // Skip empty lines and comments
                    if (!trimmedLine || trimmedLine.startsWith('#')) {
                        continue;
                    }

                    // Split by first colon
                    const colonIndex = trimmedLine.indexOf(':');
                    if (colonIndex === -1) {
                        throw new Error(`Invalid format on line: "${trimmedLine}". Expected format: "key: value"`);
                    }

                    const key = trimmedLine.substring(0, colonIndex).trim();
                    let value = trimmedLine.substring(colonIndex + 1).trim();

                    if (!key) {
                        throw new Error(`Empty key on line: "${trimmedLine}"`);
                    }

                    // Remove surrounding quotes if present
                    if ((value.startsWith('"') && value.endsWith('"')) ||
                        (value.startsWith("'") && value.endsWith("'"))) {
                        value = value.substring(1, value.length - 1);
                    }

                    // Parse value to appropriate type
                    if (value === '' || value === 'null') {
                        value = null;
                    } else if (value === 'true') {
                        value = true;
                    } else if (value === 'false') {
                        value = false;
                    } else if (!isNaN(value) && value !== '') {
                        // Convert to number if it's a valid number
                        value = parseFloat(value);
                    }
                    // Otherwise keep as string

                    options[key] = value;
                }

                if (Object.keys(options).length === 0) {
                    throw new Error('No valid options found. Use format: key: value');
                }

                console.log('Applying options:', options);
                console.log('Overwrite mode:', overwrite);

                // Define list of hidden options (not in UI but supported via YAML)
                const hiddenOptionKeys = ['cheap_boundary_highlight', 'show_cheap_price_line', 'label_use_colors', 'y_tick_use_colors', 'label_minmax_per_day', 'label_show_currency'];

                // If overwrite mode, reset all fields to defaults first
                if (overwrite) {
                    const response = await fetch('/defaults');
                    const defaults = await response.json();

                    for (let [key, value] of Object.entries(defaults)) {
                        const element = document.getElementById(key);
                        if (!element) continue;

                        if (element.type === 'checkbox') {
                            element.checked = value;
                        } else {
                            element.value = value;
                        }
                    }

                    // Clear hidden options in overwrite mode
                    for (let key of hiddenOptionKeys) {
                        delete hiddenOptions[key];
                    }
                }

                // Apply provided options
                for (let [key, value] of Object.entries(options)) {
                    const element = document.getElementById(key);
                    if (!element) {
                        // Check if this is a hidden option
                        if (hiddenOptionKeys.includes(key)) {
                            // Store in hiddenOptions object for inclusion in form data
                            hiddenOptions[key] = value;
                            console.log(`Set hidden option ${key} to ${value}`);
                        } else {
                            console.warn(`Element not found for key: ${key}`);
                        }
                        continue;
                    }

                    if (element.type === 'checkbox') {
                        element.checked = value;
                    } else {
                        // Handle null/empty values for nullable fields
                        if (value === null && ['y_tick_count', 'currency_override', 'hours_to_show', 'price_decimals'].includes(key)) {
                            element.value = '';
                        } else {
                            element.value = value;
                        }
                    }
                    console.log(`Set ${key} to ${value}`);
                }

                // Close dialog
                closeJsonOptionsDialog();

                // Render with new options
                await renderGraph();

            } catch (error) {
                errorEl.textContent = `Error: ${error.message}`;
                errorEl.style.display = 'block';
                console.error('Options parsing error:', error);
            }
        }

        // Close dialog when clicking outside
        window.addEventListener('click', (event) => {
            const dialog = document.getElementById('json-options-dialog');
            if (event.target === dialog) {
                closeJsonOptionsDialog();
            }
        });

        // Setup auto-render on any input change
        function setupAutoRender() {
            const form = document.getElementById('config-form');

            // Add change listeners to all inputs
            const inputs = form.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    input.addEventListener('change', renderGraph);
                } else if (input.type === 'number' || input.tagName === 'SELECT') {
                    input.addEventListener('change', renderGraph);
                } else if (input.type === 'text') {
                    // For text inputs, use blur event to avoid rendering on every keystroke
                    input.addEventListener('blur', renderGraph);
                }
            });
        }

        // Auto-render on page load with defaults
        window.addEventListener('load', () => {
            initTheme();
            setupAutoRender();
            renderGraph();
        });
    </script>
</body>
</html>
